<section class="subscriptions-page">
  <h1 class="title">Manage your plan and payments</h1>

  <div class="plan-content">
    <mat-card class="summary" *ngIf="sub(); else loadingTpl">
      <h2 class="summary__title">Subscription</h2>

      <div class="kv">
        <span>Current Plan:</span><strong class="value">{{ sub()?.planId || 'â€”' }}</strong>
      </div>
      <div class="kv">
        <span>Amount:</span><strong class="value">{{ amountLabel }}</strong>
      </div>
      <div class="kv">
        <span>Status:</span><strong class="value">{{ sub()?.status }}</strong>
      </div>
      <div class="kv">
        <span>Renewal:</span
        ><strong class="value">{{ sub()?.renewalDate | date : 'MM/dd/yyyy' }}</strong>
      </div>
      <div class="kv">
        <span>Payment Method:</span><strong class="value">{{ pmMask }}</strong>
      </div>
    </mat-card>

    <ng-template #loadingTpl>
      <div class="loading"><mat-spinner diameter="36"></mat-spinner></div>
    </ng-template>

    <div class="actions">

      <button mat-stroked-button color="warn" class="pill"
              (click)="onCancelPlan()"
              [disabled]="sub()?.status !== 'ACTIVE'">
        <mat-icon>cancel</mat-icon> CANCEL YOUR PLAN
      </button>

      <button mat-stroked-button color="primary" class="pill" (click)="onChangePlan()">
        <mat-icon>upgrade</mat-icon> CHANGE YOUR PLAN
      </button>
      <button mat-stroked-button class="pill" (click)="onChangeCard()">
        <mat-icon>credit_card</mat-icon> CHANGE CARD
      </button>
    </div>
  </div>

  <div class="receipt-cta">
    <button
      mat-stroked-button
      class="pill"
      (click)="onDownloadReceipt(invoices()[0])"
      [disabled]="!invoices().length || !canDownload(invoices()[0])"
    >
      <mat-icon>download</mat-icon> Download receipt
    </button>
  </div>

  <mat-card class="history" *ngIf="invoices().length">
    <h3 class="history__title">PAYMENT HISTORY</h3>

    <div class="history__table-container">
      <table mat-table [dataSource]="invoices()" class="history__table">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let r">{{ r.date | date : 'MM/dd/yyyy' }}</td>
        </ng-container>

        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Amount</th>
          <td mat-cell *matCellDef="let r">
            {{ r.amount | currency : r.currency : 'symbol' : '1.2-2' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>State</th>
          <td mat-cell *matCellDef="let r">{{ r.status }}</td>
        </ng-container>

        <ng-container matColumnDef="reference">
          <th mat-header-cell *matHeaderCellDef>Ref. No. transaction</th>
          <td mat-cell *matCellDef="let r">{{ r.reference || '-------' }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let r" class="actions-cell">
            <button mat-stroked-button
                    (click)="onViewInvoice(r)"
                    [disabled]="!canViewInvoice(r)">
              View receipt
            </button>

            <button mat-stroked-button
                    (click) = "onDownloadReceipt(r)"
                    [disabled]= "!canDownload(r)">
              Download receipt
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayed"></tr>
        <tr mat-row *matRowDef="let row; columns: displayed"></tr>
      </table>
    </div>
  </mat-card>
</section>
