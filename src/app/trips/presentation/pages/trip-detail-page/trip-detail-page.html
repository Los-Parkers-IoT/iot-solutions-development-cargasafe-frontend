<div class="trip-container">
  @if (loading()) {
  <div class="loading-overlay">
    <div class="loading-center">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading trip...</p>
    </div>
  </div>
  } @else if (error()) {
  <div class="error-banner">
    <p>{{ error() }}</p>
    <button mat-raised-button color="primary" (click)="retry()">Retry</button>
  </div>
  } @else if (trip()) {
  <div>
    <header class="trip-header">
      <h1>Trip #{{ tripId }}</h1>
      <span class="status-badge">{{ trip()?.statusId }}</span>
      <div class="trip-dates">
        <p>Created at {{ trip()?.createdAt | date : 'short' }}</p>
        <p>Departure at {{ trip()?.departureAt | date : 'short' }}</p>
      </div>
    </header>

    <div class="trip-content">
      <section class="trip-info">
        <div class="card">
          <h3>Assigned to</h3>
          <div class="card-entries">
            <p>
              <strong>Driver:</strong><br />
              {{ trip()?.driverId }}
            </p>
            <p>
              <strong>Codriver:</strong><br />
              {{ trip()?.coDriverId || 'Not assigned' }}
            </p>
          </div>
        </div>

        <div class="card">
          <h3>Shipping estimation</h3>
          <div class="card-entries">
            <p>
              <strong>Total Distance:</strong><br />
              {{ trip()?.totalDistanceKm }} km
            </p>
            <p>
              <strong>Total Duration:</strong><br />
              {{ trip()?.totalDurationMin }} min
            </p>
          </div>
        </div>

        <div class="card">
          <h3>Actual delivery</h3>
          <div class="card-entries">
            <p>
              <strong>Total Distance:</strong><br />
              Not available
            </p>
            <p>
              <strong>Total Duration:</strong><br />
              Not available
            </p>
          </div>
        </div>
      </section>

      <section class="trip-map">
        <google-map class="trip-map-cmp" [center]="center" [zoom]="zoom">
          @for (marker of markers; track marker) {
          <map-marker [position]="marker"></map-marker>
          }
          <map-polyline [path]="polylinePath" [options]="polylineOptions"></map-polyline>
        </google-map>
      </section>
    </div>

    <section class="orders-section">
      <h3>Delivery orders</h3>
      @if (deliveryOrders().length > 0) {
      <table mat-table [dataSource]="deliveryOrders()" class="mat-elevation-z1">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let order">{{ order.id }}</td>
        </ng-container>

        <ng-container matColumnDef="sequenceOrder">
          <th mat-header-cell *matHeaderCellDef>Sequence</th>
          <td mat-cell *matCellDef="let order">{{ order.sequenceOrder }}</td>
        </ng-container>

        <ng-container matColumnDef="clientEmail">
          <th mat-header-cell *matHeaderCellDef>Client</th>
          <td mat-cell *matCellDef="let order">{{ order.clientEmail }}</td>
        </ng-container>

        <ng-container matColumnDef="address">
          <th mat-header-cell *matHeaderCellDef>Address</th>
          <td mat-cell *matCellDef="let order">{{ order.address }}</td>
        </ng-container>

        <ng-container matColumnDef="arrivalAt">
          <th mat-header-cell *matHeaderCellDef>Arrival at</th>
          <td mat-cell *matCellDef="let order">{{ order.arrivalAt | date : 'short' }}</td>
        </ng-container>

        <ng-container matColumnDef="realArrivalAt">
          <th mat-header-cell *matHeaderCellDef>Real Arrival at</th>
          <td mat-cell *matCellDef="let order">
            {{ order.realArrivalAt ? (order.realArrivalAt | date : 'short') : '-' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="deliveryOrderStatusId">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let order">{{ order.deliveryOrderStatusId }}</td>
        </ng-container>

        <ng-container matColumnDef="incidents">
          <th mat-header-cell *matHeaderCellDef>Total Incidents</th>
          <td mat-cell *matCellDef="let order">{{ getIncidentsNumberByOrderId(order.id) }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      } @else {
      <p class="empty-state">No delivery orders found for this trip.</p>
      }
    </section>
  </div>
  }
</div>
